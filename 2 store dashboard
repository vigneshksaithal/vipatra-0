<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Vipatra</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <style>
      html{
      background-color: white;
      }
      #table-bill{
      width: 100%;
      background-color:#ffffff;
      }
      #total-amount-display, #submit-button{
      display: inline-block;
      }
      tr:hover{
      background-color: green;
      color: white;
      }
    </style>
  </head>
  <body>
    <link defer rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <!-- START -->
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-analytics.js"></script>
    <script>
      /*web app config*/
        var firebaseConfig = {
      apiKey: "AIzaSyB268KjjM7SMtgeZG7Zq4Gl1ozPrMFef_g",
      authDomain: "vipatra-3d522.firebaseapp.com",
      databaseURL: "https://vipatra-3d522.firebaseio.com",
      projectId: "vipatra-3d522",
      storageBucket: "vipatra-3d522.appspot.com",
      messagingSenderId: "146612162751",
      appId: "1:146612162751:web:6dd64e26e26d535861b60a",
      measurementId: "G-R3DTVJTV26"
      };
      /*Change till here*/
      /* Initialize Firebase*/         firebase.initializeApp(firebaseConfig);
        firebase.analytics();
        const db = firebase.firestore();
        const auth = firebase.auth();
    </script>
    <!--  END Firebase initial -->
    <div id="bill-input">
    <!--navbar-->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <a class="navbar-brand" href="#">Vipatra</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon">            
      </span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/store/bill">Bill</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/items">Items</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/store/reports">Reports</a>
          </li>
        </ul>
      </div>
    </nav>
    <br>
    <div class="container">
      <div class="row align-bottom">
        <div class="col-9 text-center">
          <!-- Button trigger modal -->
          <button type="button" class="btn btn-link" data-toggle="modal" data-target="#bill-modal">View bill</button>
        </div>
        <div class="col-3">
          <a data-toggle="modal" data-target="#edit-modal">
            <svg width="1.3em" height="1.3em" viewBox="0 0 16 16" class="bi bi-gear-fill" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path fill-rule="evenodd" d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 0 0-5.86 2.929 2.929 0 0 0 0 5.858z"/>
            </svg>
          </a>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <br>
          <button id="submit-button" class="btn btn-primary btn-block btn-lg" onClick="html2json()">Charge 0</button>
          <br>
          <div class="text-center">
            <h4 class="d-none" id="total-amount-display"></h4>
          </div>
          <br>
          <div class="input-group mb-3">
            <div class="input-group-prepend">
              <span class="input-group-text" id="basic-addon1">
                <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-search" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path fill-rule="evenodd" d="M10.442 10.442a1 1 0 0 1 1.415 0l3.85 3.85a1 1 0 0 1-1.414 1.415l-3.85-3.85a1 1 0 0 1 0-1.415z"/>
                  <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z"/>
                </svg>
              </span>
            </div>
            <input id="search-bar" type="text" class="form-control" placeholder="Search Item" aria-label="Search Item" aria-describedby="basic-addon1">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col">
          <table id="ex-table" class="table">
            <thead>
              <th>Item</th>
              <th>Rate</th>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <div class="row">
        <div class="col">
        </div>
      </div>
      <form id="bill-input-form">
        <h3 id="total"></h3>
      </form>
    </div>
    <br><br>
    <br><br>
    <!--modal for adding quantity -->
    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Add quantity</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="recipient-name" class="col-form-label">Quantity:</label>
                <input type="number" class="form-control" id="quantity_modal_value" value="1" autofocus>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">
            <b>Cancel</b>
            </button>
            <button id="save_quantity" type="button" class="btn btn-primary">
            <b>Save</b>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!--END modal-->
    <!--Submit modal-->
    <div class="modal fade" id="submit-modal" tabindex="-1" role="dialog" aria-labelledby="submit-modal" aria-hidden="true">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Enter customer code</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="text" id="input-customer-code" class="form-control" placeholder="customer code">
          </div>
          <div class="modal-footer">
            <button id="send-bill" type="button" class="btn btn-primary btn-block">
            <b>Send bill</b>
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- edit Modal -->
    <div class="modal fade" id="edit-modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Edit Bill</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="alert alert-warning" role="alert">
                Date is set to Todays date automatically. But if you want custom date choose below.
              </div>
              <div class="form-group">
                <label>Date (month/day/year)</label>
                <input id="bill-date" type="date" class="form-control">
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Save</button>
          </div>
        </div>
      </div>
    </div>
    <!--END submit modal-->
    <!-- Modal -->
    <div class="modal fade" id="bill-modal" tabindex="-1" aria-labelledby="bill-modal" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Bill</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center">
          <h5 id="bill-store-name">Store Name</h5>
          <span>Amount</span>
          <h2 id="bill-amount">₹0</h2>
          <table class="table" id="table-bill">
            <thead id="table-head">
              <tr id="table-head">
                <th>Item</th>
                <th>Qty</th>
                <th>Price</th>
                <th>Amount</th>
              </tr>
            </thead>
            <tbody id="table-body-bill"></tbody>
          </table>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <script>
      var bill_date, store_name, store_uid,  total_amount = 0, total_margin = 0, store_address, store_phone_no;
      
      $('#send-bill').click(() => {
        get_store_uid();
        get_store_details();
      });
      //total calculation
      var result;
      function total(){
        var rate = clicked_item_rate;
        var qn = clicked_item_quantity;
        result = parseFloat(rate) * parseFloat(qn);
        result=result.toFixed(2);
      }   
      /*showing Bill data*/
      function addRow(){
      total();
      var tableBody = document.getElementById("table-body-bill");
      var td1 = document.createElement("td");
      var td2 = document.createElement("td");
      var td3 = document.createElement("td"); 
      var td4 = document.createElement("td");   
      var row = document.createElement("tr");
           
      td1.innerHTML = clicked_item_name;
      td2.innerHTML = clicked_item_quantity;
      td3.innerHTML = clicked_item_rate;
      td4.innerHTML = result;
      
      total_margin += (clicked_item_margin* clicked_item_quantity);
      
      console.log('total profit is', total_margin);
      
      row.appendChild(td1);
      row.appendChild(td2);
      row.appendChild(td3);
      row.appendChild(td4);
      tableBody.appendChild(row);
      //calcultaing bill total
      var table_data = document.getElementById('table-body-bill');
      var table_length= table_data.rows.length;
      for(var i=table_length-1;i<table_length;i++){
        total_amount = parseFloat(total_amount)+ parseFloat(table_data.rows[i].cells.item(3).innerHTML);
           }
           total_amount=parseFloat(total_amount.toFixed(2));
           
           console.log(total_amount);
      $('#total-amount-display').html("Total = ₹" + total_amount);
      $('#submit-button').text("Charge Rs" + total_amount);
            document.getElementById('bill-input-form')
      .reset();
      }
      //END total calculation
      /*showing-items-info*/
      function renderBills (doc){
        var content = '';
        var val = doc.data();
        docID = doc.id;
        content += '<tbody onclick="javascript:row_click(this);">';
        content += '<tr>';
        content += '<td id="row-item-name">' + val.item + '</td>';
        content += '<td id="row-item-rate">' + val.salePrice + '</td>';
        content += '<td id="row-margin">' + (val.salePrice - val.purchasePrice) + '</td>';
        content += '</tr>';      
        content += '</tbody>';
        $('#ex-table').append(content);          
      }
      var clicked_item_name, clicked_item_rate, clicked_item_quantity;
      function row_click(row){
        $('#exampleModal').modal('show');
        clicked_item_name = $(row).find('#row-item-name').html();
           console.log($(row).find('#row-item-name').html());
        clicked_item_rate = $(row).find('#row-item-rate').html();
        clicked_item_margin = $(row).find('#row-margin').html();
      }
      $("#save_quantity").click(()=>{
        clicked_item_quantity = $("#quantity_modal_value").val();
        $('#exampleModal').modal('hide');
        addRow();
        $('#quantity_modal_value').val('1');
      });    
      var query = db.collection('store')
                  .doc('auth_uid')
                  .collection('items');
      query.get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          renderBills(doc);
        });
      });
      $('#submit-button').click(() => {
        $('#submit-modal').modal('show');
      });
      /*END show items*/
      /*converting table data to json*/
      var json_table_data,i=0;
      function html2json() {
          json_table_data='[';
          var otArr = [];
      /*var i = 1;Enter table id name in #*/
          var tbl2 = $('#table-bill tbody tr').each(function(e) {        
           x = $(this).children();
           var itArr = [];
           var keys = ['name','quantity','price','total'];
           x.each(function(i) {
               itArr.push('"' + keys[i] + '":"' + $(this).text() + '"');
            });
            i++;
           otArr.push('{' + itArr.join(',') + '}');
         })
           json_table_data += otArr.join(",") + ']';
           console.log(json_table_data);    
      var dbstore_name,temp_doc_id;    
      }
      /*START-filtering through search bar*/
      $(document).ready(() => {
        $("#search-bar").on("keyup", function() {
          var value = $(this).val().toLowerCase();
          $("#ex-table tr").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
          });
        });
      });
      /*END-filtering through search bar*/
      function today_date(){
       var today = new Date();
        var dd = String(today.getDate()).padStart(2, '0');
      var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
      var yyyy = today.getFullYear();
      
      today = yyyy + '-' + mm + '-' + dd;
      console.log(today);
      return today;
      }
      
      function upload_bill_to_db() {
        is_date_null();
        let cus_code = $('#customer-code').val();
        
        db.collection("bills")
        .add({
          storeUID: store_uid,
          storeInfo:{ 
            name: store_name,
            address: store_address,
            phoneNo: store_phone_no                                    
                        },
          totalAmount: total_amount,
          date: bill_date,
          items: JSON.parse(json_table_data)
        }).then(() => {
          save_transaction();
        });         
      }
      
      function get_store_details(){
        db.collection('store')
        .doc(store_uid)
        .get()
        .then((doc) => {
          console.log(doc.data().storeInfo.name);
          store_name = doc.data().storeInfo.name;
          store_address = doc.data().storeInfo.address;
          store_phone_no = parseFloat(doc.data().storeInfo.phoneNo);
          upload_bill_to_db();
        });
        
      }
             
      function save_transaction(){
        db.collection('store')
        .doc('auth_uid')
        .collection('transactions')
        .doc(bill_date)
        .set({
          date: bill_date,
          sale: firebase.firestore.FieldValue.increment(total_amount),
          margin: firebase.firestore.FieldValue.increment(parseFloat(total_margin)),
          sellerUID: store_uid
        })
        
      } 
      
      function get_store_uid(){
        store_uid = 'auth_uid';
        auth.onAuthStateChanged((user) => {
          if(user){
            store_uid = user.uid;
          }
        });        
      }
      
      function is_date_null(){
        var date = $('#bill-date').val();
        if(date==''){
          bill_date = today_date();
        }
        else{
          bill_date = $('#bill-date').val();
        }
      }
      
    /*  var docRf = db.collection('store').doc('auth_uid').collection('transactions');
      
      docRf
      .where('sale', '>', 400)
      .limit(10)
      .get()
      .then((docSnapshot) => {
        docSnapshot.forEach((doc) => {
          console.log(doc.data().sale);
        });
      });    */         
    </script>
    <script defer src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script defer src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>
  </body>
</html>
